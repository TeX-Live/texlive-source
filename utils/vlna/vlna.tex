\input cwebmac

\input csmac % Makra pro èe¹tinu
\pageheight=9.5in \fullpageheight=9.8in  \setpage
%\nocon % omit table of contents
\datethis % print date on listing

\def\begitems{\medskip\bgroup\catcode`\*=13 \narrower\narrower}
\def\enditems{\par\egroup\medskip}
{\catcode`\*=13 \gdef*{\par\noindent\llap{$\bullet$\ }\ignorespaces}}



\N{1}{1}PROGRAM VLNA.
Program ète vstupní textový soubor a nahrazuje za specifikovanými
jednopísmennými slovy (napø.~v, k, u) mezery symbolem \uv{\.{\char126}}. To
zabrání pøi následném zpracování \TeX{}em zlomit øádek na nevhodných
místech, která jsou v rozporu s typografickou normou.

Program sestává z tìchto hlavních celkù:
\Y\B\X3:Hlavièkové soubory k naètení\X\6
\X4:Globální deklarace\X\6
\X6:Pomocné funkce\X\6
\X26:Vlnkovací funkce \PB{\\{tie}}\X\6
\X5:Hlavní program\X\par
\fi

\M{2}Definujeme \PB{\.{BANNER}}, co¾ je text, který se objevi pøi startu
programu a obsahuje èíslo verze programu.
Zde je názornì vidìt, ¾e míchání dvou jazykù se nevyhneme. Pøi tisku
textù na terminál nesmíme pøedpokládat, ¾e tam budou èeské fonty.
V~této dokumentaci se setkáme se tøemi jazyky: angliètinou (vìt¹inou
v~kódu programu, cestinou v~/* komentáøích */ a èe¹tinou jinde.
Tu cestinu si vynutil fakt, ¾e DOS-ovská varianta \.{tangle} a
\.{weave} se nesná¹í s~akcentovanými písmeny v~/* komentáøích */.
A~nyní u¾ slíbený (vícejazyèný) \PB{\.{BANNER}}.
\Y\B\4\D$\.{BANNER}$ \5
\.{"This\ is\ program\ vln}\)\.{a,\ version\ 1.2,\ (c)\ }\)\.{1995,\ 2002\ Petr%
\ Olsa}\)\.{k\\n"}\par
\fi

\M{3}V programu jsou pou¾ity knihovní funkce, jejích¾ prototypy jsou
definovány ve tøech standardních hlavièkových souborech.
\Y\B\4\X3:Hlavièkové soubory k naètení\X${}\E{}$\6
\8\#\&{include} \.{<stdio.h>}\6
\8\#\&{include} \.{<string.h>}\6
\8\#\&{include} \.{<stdlib.h>}\par
\U1.\fi

\M{4}Definujeme konstanty pro návratový kód. \PB{\.{OK}} pro úspì¹ný bìh,
\PB{\.{WARNING}} pøi výskytu aspoò jedné varovné zprávy, \PB{\.{IO\_ERR}} pro
chybu
v~pøístupu ke vtupním nebo výstupním souborùm, \PB{\.{BAD\_OPTIONS}} pro
syntaktickou chybu na pøíkazové øádce a \PB{\.{BAD\_PROGRAM}} pro pøípad
havárie programu. Ta by nemìla nikdy nastat. Promìnná \PB{\\{status}} bude
obsahovat návratový kód a promìnná \PB{\\{prog\_name}} bude ukazovat na text
nultého parametru pøíkazové øádky.
\Y\B\4\D$\.{OK}$ \5
\T{0}\par
\B\4\D$\.{WARNING}$ \5
\T{1}\par
\B\4\D$\.{IO\_ERR}$ \5
\T{2}\par
\B\4\D$\.{BAD\_OPTIONS}$ \5
\T{3}\par
\B\4\D$\.{BAD\_PROGRAM}$ \5
\T{4}\par
\Y\B\4\X4:Globální deklarace\X${}\E{}$\6
\&{char} ${}{*}\\{prog\_name};{}$\6
\&{int} \\{status};\par
\As7, 15, 16, 20, 25\ETs33.
\U1.\fi

\M{5}Základní rozvr¾ení funkce \PB{\\{main}}.
\Y\B\4\X5:Hlavní program\X${}\E{}$\6
\&{int} ${}\\{main}(\\{argc},\39\\{argv}){}$\1\1\6
\&{int} \\{argc};\6
\&{char} ${}{*}{*}\\{argv};\2\2{}$\6
${}\{{}$\1\6
\X9:Lokální promìnné funkce \PB{\\{main}}\X;\6
${}\\{prog\_name}\K\\{argv}[\T{0}];{}$\6
${}\\{status}\K\.{OK};{}$\6
\X8:Naètení parametrù pøíkazového øádku\X;\6
\&{if} ${}(\R\\{silent}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{BANNER});{}$\2\6
\X21:Inicializace datových struktur\X;\6
\X11:Zpracování souborù\X;\6
\&{return} \\{status};\6
\4${}\}{}$\2\par
\U1.\fi

\N{1}{6}Parametry pøíkazového øádku.
Program ète z~pøíkazového øádku postupnì (nepovinné) parametry,
které zaèínají znakem \uv{\.{-}}. Pak následují jména vstupních a výstupních
souborù.
\begitems
* \.{-f} \dots\ program pracuje jako filtr (viz sekce \PB{$\X11:Zpracování
souborù\X$}). Není-li tento parametr pou¾it, program pracuje v tzv.
standardním re¾imu, kdy jednotlivé soubory jsou vstupní i výstupní.
* \.{-s} \dots\ program nevypí¹e \PB{\.{BANNER}}, ani sumarizaci, ani varování,
pøi nich¾ není program pøedèasnì ukonèen.  V¹echny tyto výpisy
smìøují do \PB{\\{stderr}}, tak¾e pokud program pracuje v re¾imu \uv{filtr},
není nutné tento parametr pou¾ít.
* \.{-r} \dots\ program ma¾e pracovní soubor (soubory), které vytváøí
ve standardním re¾imu (tj. není pou¾it \.{-f}). V reøimu filter nemá
tento parametr vliv.
* \.{-v} \dots\ parametr definuje skupinu písmen, které budou
interpretovány jako neslabièné pøedlo¾ky.
Napø. \.{-v KkSsVvZzOoUuAI}. Pokud není parametr uveden, je pou¾ita
skupina uvedená v tomto pøíkladì.
* \.{-m} \dots\ program neprovádí kontrolu math/text módù, tj. vlnkuje i
uvnitø matematického módu \TeX{}u. (Implicite tam nevlnkuje).
* \.{-n} \dots\ prorgram neprovádí kontrolu verbatim módu, tj. vlnkuje i
uvnitø verbatim módu definovaném bì¾nými prostøedími. Imlicite ve
verbatim prostøedí nevlnkuje.
* \.{-l} \dots\ La\TeX{} re¾im. Pøi kontrole text-math-verbatim módù jsou
brány v úvahu dal¹í sekvence, obvyklé v La\TeX{}ových dokumentech.
* \.{-w} \dots\ WEB re¾im. Ohranièení verbatim módu je doplnìno znaky
pou¾ívanými v dokumentech WEB (napø. tento dokument). Dùsledek: program
vlnkuje dokumentaèní èást ka¾dé sekce, ale nikoli kód.
\enditems

Definujeme funkci \PB{\\{printusage}}, které tiskne (pøi chybì) struèný pøehled
mo¾ných parametrù. Nepodaøilo se mi zjistit, jak se ve WEBu napí¹e
kulturnì dlouhý string obsahující \.{\char92n} s formátovacími
po¾adavky. Byl jsem nucen to takto nehezky zapsat.
\Y\B\4\X6:Pomocné funkce\X${}\E{}$\6
\&{void} \\{printusage}(\,)\1\1\2\2\6
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"usage:\ vlna\ [opt]\ [}\)\.{filenames]\\n"}%
\.{"\ \ opt\ -f\ :\ \ filter\ }\)\.{mode:\ file1\ file2\ ..}\)\.{.\
file1->file2\\n"}\.{"\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }\)\.{\ \ \ \ \ \
file1\ \ \ \ \ \ \ ..}\)\.{.\ file1->stdout\\n"}\.{"\ \ \ \ \ \ \ \ \ \ \ \ \ \
\ \ \ \ \ }\)\.{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ..}\)\.{.\ stdin->stdout%
\\n"}\.{"\ \ \ \ \ \ \ \ \ \ \ \ nofilte}\)\.{r:\ file1\ [file2\ file}\)\.{3\
...]\ all\ are\ in/ou}\)\.{t\\n"}\.{"\ \ \ \ \ \ -s\ :\ \ silent:}\)\.{\ no\
messages\ to\ stde}\)\.{rr\\n"}\.{"\ \ \ \ \ \ -r\ :\ \ rmbacku}\)\.{p:\ if\
nofilter,\ remo}\)\.{ves\ temporary\ files\\}\)\.{n"}\.{"\ \ \ \ \ \ -v\
charset\ :\ }\)\.{\ set\ of\ lettres\ to\ a}\)\.{dd\ tie,\ default:\ KkS}\)%
\.{sVvZzOoUuAI\\n"}\.{"\ \ \ \ \ \ -m\ :\ \ nomath:}\)\.{\ ignores\ math\ modes%
\\}\)\.{n"}\.{"\ \ \ \ \ \ -n\ :\ \ noverb:}\)\.{\ ignores\ verbatim\ mo}\)%
\.{des\\n"}\.{"\ \ \ \ \ \ -l\ :\ \ LaTeX\ m}\)\.{ode\\n"}\.{"\ \ \ \ \ \ -w\ :%
\ \ web\ mod}\)\.{e\\n"});{}$\6
\4${}\}{}$\2\par
\As10, 17, 18, 19, 22, 23, 36, 38, 41, 42, 44, 45, 47, 49, 51, 52, 53\ETs55.
\U1.\fi

\M{7}Promìnné \PB{\\{isfilter}}, \PB{\\{silent}}, \PB{\\{rmbackup}}, \PB{%
\\{nomath}}, \PB{\\{noverb}},
\PB{\\{latex}}, resp. \PB{\\{web}} øíkají, ¾e je nastaven parametr \.{-f}, %
\.{-s},
\.{-r}, \.{-m}, \.{-n}, \.{-l}, resp. \.{-w}.  Promìnná \PB{\\{charset}}
ukazuje buï na implicitní skupinu znakù \PB{\\{charsetdefault}}, nebo (pøi
pou¾ití parametru \.{-v}) na text uvedený v pøíkazovém øádku.
\Y\B\4\X4:Globální deklarace\X${}\mathrel+\E{}$\6
\&{int} \\{isfilter}${}\K\T{0},{}$ \\{silent}${}\K\T{0},{}$ \\{rmbackup}${}\K%
\T{0},{}$ \\{nomath}${}\K\T{0},{}$ \\{noverb}${}\K\T{0},{}$ \\{web}${}\K%
\T{0},{}$ \\{latex}${}\K\T{0};{}$\6
\&{char} \\{charsetdefault}[\,]${}\K\.{"KkSsVvZzOoUuAI"};{}$\6
\&{char} ${}{*}\\{charset}\K\\{charsetdefault}{}$;\par
\fi

\M{8}\B\X8:Naètení parametrù pøíkazového øádku\X${}\E{}$\6
\&{while} ${}(\\{argc}>\T{1}\W\\{argv}[\T{1}][\T{0}]\E\.{'-'}){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{argv}[\T{1}][\T{2}]\I\T{0}){}$\1\5
${}\\{printusage}(\,),\39\\{exit}(\.{BAD\_OPTIONS});{}$\2\6
\&{switch} (\\{argv}[\T{1}][\T{1}])\5
${}\{{}$\1\6
\4\&{case} \.{'f'}:\5
${}\\{isfilter}\K\T{1};{}$\6
\&{break};\6
\4\&{case} \.{'s'}:\5
${}\\{silent}\K\T{1};{}$\6
\&{break};\6
\4\&{case} \.{'r'}:\5
${}\\{rmbackup}\K\T{1};{}$\6
\&{break};\6
\4\&{case} \.{'v'}:\6
\&{if} ${}(\\{argc}<\T{2}){}$\1\5
${}\\{printusage}(\,),\39\\{exit}(\.{BAD\_OPTIONS});{}$\2\6
${}\\{argv}\PP;{}$\6
${}\\{argc}\MM;{}$\6
${}\\{charset}\K\\{argv}[\T{1}];{}$\6
\&{break};\6
\4\&{case} \.{'m'}:\5
${}\\{nomath}\K\T{1};{}$\6
\&{break};\6
\4\&{case} \.{'n'}:\5
${}\\{noverb}\K\T{1};{}$\6
\&{break};\6
\4\&{case} \.{'l'}:\5
${}\\{latex}\K\T{1};{}$\6
\&{break};\6
\4\&{case} \.{'w'}:\5
${}\\{web}\K\T{1};{}$\6
\&{break};\6
\4\&{default}:\5
${}\\{printusage}(\,),\39\\{exit}(\.{BAD\_OPTIONS}){}$;\C{ nezn\'am\'y parametr
}\6
\4${}\}{}$\2\6
${}\\{argc}\MM;{}$\6
${}\\{argv}\PP;{}$\6
\4${}\}{}$\2\par
\U5.\fi

\N{1}{9}Zpracování souborù.  Parametr \PB{\.{MAXLEN}} definuje maximální mo¾nou
délku jména souboru, který vytvoøíme jako pøechodný, nebo zálohový.
Dále deklarujeme promìnné typu \uv{stream}.
\Y\B\4\D$\.{MAXLEN}$ \5
\T{120}\par
\Y\B\4\X9:Lokální promìnné funkce \PB{\\{main}}\X${}\E{}$\6
\&{FILE} ${}{*}\\{infile},{}$ ${}{*}\\{outfile};{}$\6
\&{char} \\{backup}[\.{MAXLEN}];\6
\&{int} \|j;\par
\U5.\fi

\M{10}Definujeme funkci pro výpis chybového hlá¹ení pøi neúspì¹ném otevøení
souboru.
\Y\B\4\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} \\{ioerr}(\|f)\1\1\6
\&{char} ${}{*}\|f;\2\2{}$\6
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"\%s:\ cannot\ open\ fil}\)\.{e\ \%s\\n"},\39%
\\{prog\_name},\39\|f);{}$\6
\4${}\}{}$\2\par
\fi

\M{11}Zpùsob zpracování souborù rozli¹íme podle re¾imu daným pøepínaèem \.{-f}.
\Y\B\4\X11:Zpracování souborù\X${}\E{}$\6
\&{if} (\\{isfilter}) \X12:Zpracování v re¾imu filter\X\6
\&{else} \X13:Zpracování v¹ech souborù pøíkazové øádky\X\par
\Q6.
\U5.\fi

\M{12}V re¾imu \PB{$\\{isfilter}\E\T{1}$} je dal¹í zpracování závislé na poètu
souborù v
pøíkazové øádce:
\begitems
* nula souborù -- vstup je \PB{\\{stdin}} a výstup je \PB{\\{stdout}},
* jeden soubor -- je vstupní, výstup je \PB{\\{stdout}},
* dva soubory -- první je vstupní, druhý výstupní,
* více souborù -- program skonèí s chybou.
\enditems
\Y\B\4\X12:Zpracování v re¾imu filter\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{argc}>\T{3}){}$\1\5
${}\\{printusage}(\,),\39\\{exit}(\.{BAD\_OPTIONS});{}$\2\6
${}\\{infile}\K\\{stdin};{}$\6
${}\\{outfile}\K\\{stdout};{}$\6
\&{if} ${}(\\{argc}\G\T{2}){}$\1\5
${}\\{infile}\K\\{fopen}(\\{argv}[\T{1}],\39\.{"r"});{}$\2\6
\&{if} ${}(\\{infile}\E\NULL){}$\1\5
${}\\{ioerr}(\\{argv}[\T{1}]),\39\\{exit}(\.{IO\_ERR});{}$\2\6
\&{if} ${}(\\{argc}\E\T{3}){}$\1\5
${}\\{outfile}\K\\{fopen}(\\{argv}[\T{2}],\39\.{"w"});{}$\2\6
\&{if} ${}(\\{outfile}\E\NULL){}$\1\5
${}\\{ioerr}(\\{argv}[\T{2}]),\39\\{exit}(\.{IO\_ERR});{}$\2\6
\&{if} ${}(\\{argc}\G\T{2}){}$\1\5
${}\\{filename}\K\\{argv}[\T{1}];{}$\2\6
\&{else}\1\5
${}\\{filename}\K\NULL;{}$\2\6
${}\\{tie}(\\{infile},\39\\{outfile});{}$\6
\&{if} ${}(\\{outfile}\I\\{stdout}){}$\1\5
\\{fclose}(\\{outfile});\2\6
\&{if} ${}(\\{infile}\I\\{stdin}){}$\1\5
\\{fclose}(\\{infile});\2\6
\4${}\}{}$\2\par
\U11.\fi

\M{13}V~re¾imu \PB{$\\{isfilter}\E\T{0}$} jsou jednotlivé soubory v~pøíkazovém
øádku
interpretovány jako vstupní i výstupní. Více souborù v~pøíkazovém øádku má
stejný efekt, jako opakované volání programu na jednotlivé soubory.
V~\UNIX/u lze tedy napø. napsat \.{\jobname\ *.tex} a program doplní vlnky do
v¹ech souborù s~pøíponou~\.{tex}. Toto neplatí v~DOSu, proto¾e interpretace
masky je v~\UNIX/u starostí shellu a nikoli programu samotného. Ná¹ program
masku nebude interpretovat. Je-li v~tomto re¾imu nulový poèet souborù,
program se ukonèí s~chybou.
\Y\B\4\X13:Zpracování v¹ech souborù pøíkazové øádky\X${}\E{}$\6
${}\{{}$\1\6
\&{if} ${}(\\{argc}\E\T{1}){}$\1\5
${}\\{printusage}(\,),\39\\{exit}(\.{BAD\_OPTIONS});{}$\2\6
\&{while} ${}(\\{argc}>\T{1}){}$\5
${}\{{}$\1\6
${}\\{argc}\MM;{}$\6
${}\\{argv}\PP;{}$\6
\X14:Pøejmenuj vstup \PB{\\{argv}[\T{0}]} na \PB{\\{backup}} a otevøi jej jako %
\PB{\\{infile}}\X;\6
\&{if} ${}(\\{infile}\E\NULL){}$\5
${}\{{}$\1\6
\\{ioerr}(\\{argv}[\T{0}]);\6
\&{continue};\6
\4${}\}{}$\2\6
${}\\{outfile}\K\\{fopen}(\\{argv}[\T{0}],\39\.{"w"});{}$\6
\&{if} ${}(\\{outfile}\E\NULL){}$\5
${}\{{}$\1\6
\\{ioerr}(\\{argv}[\T{0}]);\6
${}\\{rename}(\\{backup},\39\\{argv}[\T{0}]);{}$\6
${}\\{status}\K\.{WARNING};{}$\6
\&{continue};\6
\4${}\}{}$\2\6
${}\\{filename}\K\\{argv}[\T{0}];{}$\6
${}\\{tie}(\\{infile},\39\\{outfile});{}$\6
${}\\{fclose}(\\{outfile}),\39\\{fclose}(\\{infile});{}$\6
\&{if} (\\{rmbackup})\1\5
\\{remove}(\\{backup});\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U11.\fi

\M{14}Pøi \PB{$\\{isfilter}\E\T{0}$} program pøejmenuje ka¾dý  zpracovávaný
soubor tak, ¾e
zmìní poslední písmeno názvu souboru na znak \.{\char126}. Tento
pøejmenovaný soubor bude otevøen jako vstupní a výstupem bude pùvodní
soubor. Vstupní soubor pøi \PB{$\\{rmbackup}\E\T{0}$} zùstane zachován jako
záloha.

Proè vlnku nepøidáváme na konec názvu souboru, ale mìníme ji za poslední
znak souboru? Proto¾e chceme, aby program fungoval i v tak nemo¾ných
systémech, jako je DOS.
\Y\B\4\X14:Pøejmenuj vstup \PB{\\{argv}[\T{0}]} na \PB{\\{backup}} a otevøi jej
jako \PB{\\{infile}}\X${}\E{}$\6
$\\{infile}\K\NULL;{}$\6
${}\|j\K\\{strlen}(\\{argv}[\T{0}])-\T{1};{}$\6
\&{if} ${}(\|j\G\.{MAXLEN}\V\\{argv}[\T{0}][\|j]\E\.{'\~'}){}$\5
${}\{{}$\1\6
\&{if} ${}(\R\\{silent}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\%s:\ the\ conflict\ of}\)\.{\ file\ name\ \%s%
\\n"},\39\\{prog\_name},\39\\{argv}[\T{0}]);{}$\2\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{strcpy}(\\{backup},\39\\{argv}[\T{0}]);{}$\6
${}\\{backup}[\|j]\K\.{'\~'};{}$\6
\\{remove}(\\{backup});\6
${}\|j\K\\{rename}(\\{argv}[\T{0}],\39\\{backup});{}$\6
\&{if} ${}(\|j\E\T{0}){}$\1\5
${}\\{infile}\K\\{fopen}(\\{backup},\39\.{"r"});{}$\2\6
\4${}\}{}$\2\par
\U13.\fi

\N{1}{15}Patterny.  Abychom mohli úèelnì definovat chování programu
v~rùzných situacích, zavedeme datovou strukturu \PB{\.{PATTERN}}. Zhruba
øeèeno, budeme sledovat vstup znak po znaku a pokud bude èást vstupu
souhlasit s~definovaným patternem, provedeme námi po¾adovanou
akci. Napøíklad nejèastìj¹í aktivitu, pøidání vlnky uvnitø øádku,
spustíme v~okam¾iku, kdy vstupní text odpovídá patternu \uv{\.{\ (v\
p}}, kde \uv{\.{\ }} znamená jedna nebo více mezer a tabelátorù,
\uv{\.{(}} je nula nebo více otevíracích závorek v¹eho druhu,
\uv{\.{v}} znamená jedno písmeno z~mno¾iny pøedlo¾ek (viz \PB{\\{charset}}) a
\uv{\.{p}} zde znamená libovolné písmeno. Pøíklad zde není zcela pøesný.
Pøesnì jsou v¹echny patterny pro ná¹ program definovány v~závìreèných
sekcích tohoto povídání.

Pattern bude znamenat koneènou sekvenci tzv. pozic patternu (\PB{\.{PATITEM}}).
Cykly uvnitø pozic pro jednoduchost nepøipustíme. Ka¾dá pozice obsahuje
øetìzec znakù, uva¾ovaný pro danou pozici (v~pøíkladu pozice~\uv{\.{\ }} by
obsahovala mezeru a tabelátor, zatímco pozice \.{v} odpovídá \PB{\\{charset}}).
Ka¾dá pozice má svùj pøepínaè (\PB{\\{flag}}), který obsahuje informaci o~tom,
zda shodu testovaného znaku s~nìkterým prvkem v~mno¾inì znakù
budeme pova¾ovat za úspìch èi neúspìch a zda pozice se ve zkoumaném
øetìzci mù¾e vyskytovat právì jednou nebo opakovanì. Jako druhý pøípad
staèí implementovat \uv{nula nebo více} proto¾e \uv{jedna nebo více} lze
popsat pomocí dvou pozic, první \uv{právì jednou} a následující \uv{nula
nebo více}. Jednotlivé pozice jsou zøetìzeny ukazatelem \PB{\\{next}}, poslední
pozice má \PB{$\\{next}\E\NULL$}. Stejnì tak jednotlivé patterny budeme
sestavovat do seznamù a budou rovnì¾ zøetìzeny ukazatelem \PB{\\{next}}.

Pattern kromì øetìzu pozic obsahuje ukazatel na funkci (proceduru) \PB{%
\\{proc}},
která se má vykonat v~pøípadì, ¾e testovaný øetìzec vyhovuje patternu.

\Y\B\4\D$\.{ONE}$ \5
\T{1}\C{ flag: prave jeden vyskyt }\par
\B\4\D$\.{ANY}$ \5
\T{2}\C{ flag: nula nebo vice }\par
\B\4\D$\.{ONE\_NOT}$ \5
${-}{}$\T{1}\C{ flag: prave jednou, znak nesmi byt v mnozine }\par
\B\4\D$\.{ANY\_NOT}$ \5
${-}{}$\T{2}\C{ flag: nula nebo vice, znak nesmi byt v mnozine }\par
\Y\B\4\X4:Globální deklarace\X${}\mathrel+\E{}$\6
\&{typedef} \&{struct} \&{PATITEM} ${}\{{}$\C{ jedna pozice patternu }\1\6
\&{char} ${}{*}\\{str}{}$;\C{ seznam znaku na teto pozici }\6
\&{int} \\{flag};\C{ vyznam seznamu znaku }\6
\&{struct} \&{PATITEM} ${}{*}\\{next}{}$;\C{ nasledujici pozice patternu }\2\6
${}\}{}$ \&{PATITEM};\6
\&{typedef} \&{struct} \&{PATTERN} ${}\{{}$\C{ jeden pattern }\1\6
\&{PATITEM} ${}{*}\\{patt}{}$;\C{ ukazatel na prvni pozici }\7
${}\&{void}({*}\\{proc})(\,){}$;\C{ procedura spustena pri souhlasu patternu }\7
\&{struct} \&{PATTERN} ${}{*}\\{next}{}$;\C{ nasledujici v seznamu vsech
patternu }\2\6
${}\}{}$ \&{PATTERN};\par
\fi

\M{16}Deklarujeme nìkteré globální promìnné pro práci s~patterny. \PB{\\{lapi}}
je pole
obsahující ukazatele na aktuální pozice v~otevøených patternech. Øíkáme,
¾e \uv{pattern je otevøen}, pokud zkoumaný øetìzec s~ním {\it zaèíná\/}
souhlasit. Pattern se uzavøe, pokud nastane jedna ze dvou mo¾ností:
zkoumaný øetìzec s~mím souhlasí a¾ do konce (v~takovém pøípadì se provede
procedura \PB{\\{proc}}), nebo pøi vy¹etøování dal¹ích znakù ze zkoumaného
øetìzce pøestane øetìzec s~patternem souhlasit.

V~dané chvíli mù¾e být pattern otevøen nìkolikrát. Napø. pattern \.{abac}
je pøi stringu \.{aba} pøi výskytu druhého \.{a} otevøen podruhé. Proto
pole obsahuje ukazatele na právì aktuální pozici patternu a nikoli na
pattern jako takový.

V~poli \PB{\\{lapi}} budou na poèátku samá \PB{$\NULL$} (to se pøi pøekladu
inicializuje
samo) a pøemazání ukazatele na pozici konstantou \PB{$\NULL$} budeme pova¾ovat
za zavøení patternu. Vedle pole \PB{\\{lapi}} soumìrnì udr¾ujeme pole \PB{%
\\{lapt}},
do nìho¾ budeme ukládat ukazatele na odpovídající otevøený pattern. Tuto
informaci pou¾ijeme v~pøípadì, ¾e potøebujeme napø, znát \PB{\\{proc}}
patternu.

\PB{\\{listpatt}} bude ukazovat na zaèátek aktuálního seznamu patternù. Seznamy
budeme mít dva. Jeden se pou¾ije, nacházíme-li se mimo komentáø a druhý
v~pøípadì, ¾e se nacházíme v~prostoru \TeX{}ovského komentáøe (tj. za
procentem). Starty tìchto seznamù patternù jsou \PB{\\{normallist}} a
\PB{\\{commentlist}} a aktivní \PB{\\{listpatt}} má v¾dy jednu z~tìchto dvou
hodnot.

Promìnné \PB{\\{lastpt}} a \PB{\\{lastpi}} pou¾ijeme pro budování øetìzové
struktury
patternù.

Promìnná \PB{\|c} obsahuje právì testovaný znak ze vstupu (který se rovnì¾
pøepí¹e do bufferu \PB{\\{buff}}). Z~bufferu obèas ukládáme data do výstupního
proudu. Dìláme to ale v¾dy jen v~okam¾iku, kdy není otevøen ¾ádný
pattern. Tehdy toti¾ \uv{nehrozí} situace, ¾e by nìjaká procedura vyvolaná
souhlasem patternu po¾adovala v~tomto bufferu nìjaké zmìny se zpìtnou
platností. O~vyprázdnìní bufferu se zaèneme zajímat a¾ v~okam¾iku, kdy je
zaplnìn aspoò na hodnotu \PB{\.{BUFI}}, abychom proceduru pøepisu bufferu do
výstupního proudu neaktivovali zbyteènì èasto.
\Y\B\4\D$\.{MAXPATT}$ \5
\T{200}\C{ maximalni pocet patternu }\par
\B\4\D$\.{MAXBUFF}$ \5
\T{500}\C{ velikost bufferu pro operace }\par
\B\4\D$\.{BUFI}$ \5
\T{300}\C{ velikost stredniho zaplneni }\par
\Y\B\4\X4:Globální deklarace\X${}\mathrel+\E{}$\6
\&{PATITEM} ${}{*}\\{lapi}[\.{MAXPATT}]{}$;\C{ pole ukazatelu na aktualni
pozice }\6
\&{PATTERN} ${}{*}\\{lapt}[\.{MAXPATT}]{}$;\C{ pole odpovidajicich ukazatelu na
patterny }\6
\&{PATTERN} ${}{*}\\{listpatt},{}$ ${}{*}\\{normallist},{}$ ${}{*}%
\\{commentlist},{}$ ${}{*}\\{pt},{}$ ${}{*}\\{lastpt}\K\NULL;{}$\6
\&{PATITEM} ${}{*}\\{pi},{}$ ${}{*}\\{lastpi}\K\NULL;{}$\6
\&{char} \|c;\C{ zrovna nacetny znak }\6
\&{char} \\{buff}[\.{MAXBUFF}];\C{ prechodny buffer }\6
\&{int} \\{ind};\C{ aktualni pozice prechodneho bufferu }\par
\fi

\M{17}Nyní definujeme pomocné funkce \PB{\\{setpattern}}, \PB{\\{setpi}} a \PB{%
\\{normalpattern}}.
Tyto funkce alokují pamì» pomocí standardní funkce \PB{\\{malloc}}. Abychom
mohli
ohlídat pøípadnou chybu pøi alokaci, budeme allokovat pamì» zprostøedkovanì
pomocí funkce \PB{\\{myalloc}}.
\Y\B\4\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} ${}{*}\\{myalloc}(\\{size}){}$\1\1\6
\&{int} \\{size};\2\2\6
${}\{{}$\1\6
\&{void} ${}{*}\|p;{}$\7
${}\|p\K\\{malloc}(\\{size});{}$\6
\&{if} ${}(\|p\E\NULL){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"\%s,\ no\ memory,\ mall}\)\.{oc\ failed\\n"},%
\39\\{prog\_name});{}$\6
\\{exit}(\.{BAD\_PROGRAM});\6
\4${}\}{}$\2\6
\&{return} \|p;\6
\4${}\}{}$\2\par
\fi

\M{18}Funkce \PB{\\{setpattern}} alokuje pamì»ové místo struktury \PB{%
\&{PATTERN}} a napojí
ji pomocí promìnné \PB{\\{lastpt}} na u¾ alokovaný øetìz patternù.
Vrátí ukazatel na novì alokované místo. Jednotlivé pozice patternu se musí
následovnì alokovat pomocí \PB{\\{setpi}}.
\Y\B\4\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{PATTERN} ${}{*}{}$\\{setpattern}(\\{proc})\6
${}\&{void}({*}\\{proc})(\,);{}$\7
${}\{{}$\1\6
\&{PATTERN} ${}{*}\\{pp};{}$\7
${}\\{pp}\K\\{myalloc}(\&{sizeof}(\&{PATTERN}));{}$\6
${}\\{pp}\MG\\{proc}\K\\{proc};{}$\6
${}\\{pp}\MG\\{next}\K\NULL;{}$\6
${}\\{pp}\MG\\{patt}\K\NULL;{}$\6
\&{if} ${}(\\{lastpt}\I\NULL){}$\1\5
${}\\{lastpt}\MG\\{next}\K\\{pp};{}$\2\6
${}\\{lastpt}\K\\{pp};{}$\6
${}\\{lastpi}\K\NULL;{}$\6
\&{return} \\{pp};\6
\4${}\}{}$\2\par
\fi

\M{19}Funkce \PB{\\{setpi}} alokuje pamì»ové místo pro jednu pozici patternu.
Provede
zøetìzení tak, aby první pozice øetìzu pozic byla zaznamenána v polo¾ce
\PB{\\{patt}} ve struktuøe \PB{\&{PATTERN}} a dal¹í byly provázány polo¾kou %
\PB{\\{next}} ve
struktuøe \PB{\&{PATITEM}}. Poslední pozice má \PB{$\\{next}\E\NULL$}.
\Y\B\4\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} ${}\\{setpi}(\\{str},\39\\{flag}){}$\1\1\6
\&{char} ${}{*}\\{str};{}$\6
\&{int} \\{flag};\2\2\6
${}\{{}$\1\6
\&{PATITEM} ${}{*}\|p;{}$\7
${}\|p\K\\{myalloc}(\&{sizeof}(\&{PATITEM}));{}$\6
${}\|p\MG\\{str}\K\\{str};{}$\6
${}\|p\MG\\{flag}\K\\{flag};{}$\6
${}\|p\MG\\{next}\K\NULL;{}$\6
\&{if} ${}(\\{lastpi}\E\NULL){}$\1\5
${}\\{lastpt}\MG\\{patt}\K\|p;{}$\2\6
\&{else}\1\5
${}\\{lastpi}\MG\\{next}\K\|p;{}$\2\6
${}\\{lastpi}\K\|p;{}$\6
\4${}\}{}$\2\par
\fi

\M{20}Pøipravme si pùdu pro funkci \PB{\\{normalpattern}}. Tato funkce alokuje
strukturu pro jeden pattern vèetnì pozic patternu na základì vstupního
stringu. Ka¾dá pozice patternu obsahuje v~mno¾inì znakù jediný znak a má
\PB{$\\{flag}\K\.{ONE}$}. Znaky ve vstupním stringu odpovídají po øadì
jednotlivým
pozicím. Vytvoøí se vlastnì jakýsi absolutní pattern, tj. testovaný øetìzec
se musí pøesnì shodovat s~uvedeným stringem. Výjimku tvoøí znak \PB{\.{"."}},
který se interpretuje jako nula nebo více mezer. Chceme-li teèku
vnutit do patternu, napí¹eme dvì teèky za sebou.

Nejdøíve deklarujeme pole v¹ech mo¾ných jednopísmenných stringù.
\Y\B\4\X4:Globální deklarace\X${}\mathrel+\E{}$\6
\&{char} \\{strings}[\T{512}];\6
\&{int} \|i;\par
\fi

\M{21}Inicializujeme toto pole (znak, nula, znak, nula, atd...).
\Y\B\4\X21:Inicializace datových struktur\X${}\E{}$\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\T{256};{}$ ${}\|i\PP){}$\5
${}\{{}$\1\6
${}\\{strings}[\T{2}*\|i]\K{}$(\&{char}) \|i;\6
${}\\{strings}[\T{2}*\|i+\T{1}]\K\T{0};{}$\6
\4${}\}{}$\2\par
\As34, 37, 39, 40, 43, 46, 48, 50\ETs54.
\U5.\fi

\M{22}Definujme funkci \PB{\\{normalpattern}}.
\Y\B\4\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{PATTERN} ${}{*}\\{normalpattern}(\\{proc},\39\\{str}{}$)\6
${}\&{void}({*}\\{proc})(\,);{}$\6
\&{char} ${}{*}\\{str};{}$\7
${}\{{}$\1\6
\&{PATTERN} ${}{*}\\{pp};{}$\6
\&{int} \|j${}\K\T{0};{}$\7
${}\\{pp}\K\\{setpattern}(\\{proc});{}$\6
\&{while} (\\{str}[\|j])\5
${}\{{}$\1\6
\&{if} ${}(\\{str}[\|j]\E\.{'.'}){}$\5
${}\{{}$\1\6
${}\|j\PP;{}$\6
\&{if} ${}(\\{str}[\|j]\I\.{'.'}){}$\5
${}\{{}$\1\6
${}\\{setpi}(\\{blankscr},\39\.{ANY});{}$\6
\&{continue};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\6
${}\\{setpi}({\AND}\\{strings}{}$[(\&{unsigned} \&{char}) \\{str}[\|j]${}*%
\T{2}],\39\.{ONE});{}$\6
${}\|j\PP;{}$\6
\4${}\}{}$\2\6
\&{return} \\{pp};\6
\4${}\}{}$\2\par
\fi

\M{23}Funkce \PB{\\{match}}. Definujeme funkci, která na základì hodnoty znaku %
\PB{\|c}
(promìnná \PB{\|c} je definována jako globální), a pozice patternu \PB{\|p}
(parametr
funkce) vrátí informaci o tom, zda znak souhlasí s patternem. Záporná èísla
\PB{\.{FOUND}}, resp. \PB{\.{NOFOUND}} znamenají, ¾e je tøeba uzavøít pattern s
tím, ¾e
vzor odpovídá, resp. neodpovídá patternu. Nezáporné èíslo vrátí v pøípadì,
¾e zkoumaný vstup stále souhlasí s patternem, ale není je¹tì
rozhodnuto. Velikost návratové hodnoty v takovém pøípadì udává, o kolik
pozic je tøeba se posunout v patternu, abychom mìli ukazatel na pozici
patternu v souhlase s novou situací, zpùsobenou znakem \PB{\|c}.

Pokud je \PB{\|c} v mno¾inì znakù pro danou pozici \PB{$\|p\MG\\{str}$}, bude %
\PB{$\|m\E\T{1}$}, jinak
je \PB{$\|m\E{-}\T{1}$}. Pokud tímto èíslem pronásobíme hodnotu \PB{$\|p\MG%
\\{flag}$}, nemusíme
vìtvení podle \PB{$\|p\MG\\{flag}$} programovat dvakrát. Hodnoty \PB{\\{flag}}
jsou toti¾
symetrické podle nuly, napø. \PB{$\.{ANY}\E{-}\.{ANY\_NOT}$}.
\Y\B\4\D$\.{FOUND}$ \5
${-}{}$\T{1}\par
\B\4\D$\.{NOFOUND}$ \5
${-}{}$\T{2}\par
\Y\B\4\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{int} \\{match}(\|p)\1\1\6
\&{PATITEM} ${}{*}\|p;\2\2{}$\6
${}\{{}$\1\6
\&{int} \|m;\7
\&{if} ${}(\\{strchr}(\|p\MG\\{str},\39\|c)\I\NULL){}$\1\5
${}\|m\K\T{1}{}$;\C{ Znak nalezen }\2\6
\&{else}\1\5
${}\|m\K{-}\T{1}{}$;\C{ Znak nenalezen }\2\6
\&{switch} ${}(\|m*\|p\MG\\{flag}){}$\5
${}\{{}$\1\6
\4\&{case} \.{ANY}:\5
\&{return} \T{0};\C{ Souhas, neni nutny posun }\6
\4\&{case} \.{ONE}:\6
\&{if} ${}(\|p\MG\\{next}\E\NULL){}$\1\5
\&{return} \.{FOUND};\2\6
\&{return} \T{1};\C{ Souhas, nutny posun o 1 }\6
\4\&{case} \.{ONE\_NOT}:\5
\&{return} \.{NOFOUND};\C{ Nesouhlas }\6
\4\&{case} \.{ANY\_NOT}:\5
\X24:Vra» hodnotu podle následující pozice patternu\X;\6
\4${}\}{}$\2\6
\&{return} \T{0};\C{ Tady bychom nikdy nemeli byt, return pro potlaceni
varovani }\6
\4${}\}{}$\2\par
\fi

\M{24}O kolik pozic je tøeba se posunout a s jakým výsledkem zjistíme
rekurzivním voláním funkce \PB{\\{match}}.
\Y\B\4\X24:Vra» hodnotu podle následující pozice patternu\X${}\E{}$\6
\&{switch} ${}(\|m\K\\{match}(\|p\MG\\{next})){}$\5
${}\{{}$\1\6
\4\&{case} \.{NOFOUND}:\5
\&{return} \.{NOFOUND};\6
\4\&{case} \.{FOUND}:\5
\&{return} \.{FOUND};\6
\4\&{default}:\5
\&{return} \T{1}${}+\|m;{}$\6
\4${}\}{}$\2\par
\U23.\fi

\N{1}{25}Vlnkovací funkce.
Nejprve pøipravíme globální deklarace pro \uv{vlnkovací} funkci \PB{\\{tie}}.
Funkce \PB{\\{tie}} \uv{ovlnkuje} vstupní soubor \PB{\\{infile}} a vytvoøí
soubor
\PB{\\{outfile}}.  Pøi \PB{$\\{silent}\K\T{0}$} tiskne závìreènou zprávu o
zpracování. V této
zprávì se objeví jméno souboru, které se funkce \uv{dozví} prostøednictvím
globální promìnné \PB{\\{filename}}. Promìnná \PB{\\{numline}} poèítá øádky,
promìnná
\PB{\\{numchanges}} sèítá zmìny, tj. poèet doplnìných vlnek.
Promìnná \PB{\\{mode}} nabývý nìkteré z hodnot \PB{\.{TEXTMODE}}, \PB{%
\.{MATHMODE}},
\PB{\.{DISPLAYMODE}} a \PB{\.{VERBMODE}} podle stavu ve èteném textu.
\Y\B\4\D$\.{TEXTMODE}$ \5
\T{0}\par
\B\4\D$\.{MATHMODE}$ \5
\T{1}\par
\B\4\D$\.{DISPLAYMODE}$ \5
\T{2}\par
\B\4\D$\.{VERBMODE}$ \5
\T{3}\par
\Y\B\4\X4:Globální deklarace\X${}\mathrel+\E{}$\6
\&{char} ${}{*}\\{filename}{}$;\C{ jmeno zpracovavaneho souboru }\6
\&{long} \&{int} \\{numline}${},{}$ \\{numchanges};\C{ pro zaverecnou
statistiku }\6
\&{int} \\{mode};\par
\fi

\M{26}Nyní definujeme vlnkovací funkci \PB{\\{tie}}. Ve¹kerá èinnost se opírá o
strukturu patternù. Výhodné je (z dùvodu rychlosti) \uv{natvrdo} zde
implementovat jen pøepínání mezi stavem ètení z oblasti komentáøe
(\PB{$\\{listpatt}\E\\{commentlist}$}) a mimo komentáø (\PB{$\\{listpatt}\E%
\\{normallist}$});
\Y\B\4\X26:Vlnkovací funkce \PB{\\{tie}}\X${}\E{}$\6
\&{void} ${}\\{tie}(\\{input},\39\\{output}){}$\1\1\6
\&{FILE} ${}{*}\\{input},{}$ ${}{*}\\{output};\2\2{}$\6
${}\{{}$\1\6
\&{int} \\{ap};\C{ ap je pocet otevrenych patternu }\6
\&{register} \&{int} \|k${},{}$ \|m${},{}$ \|n;\6
\&{int} \\{ic};\6
\&{PATTERN} ${}{*}\\{pp};{}$\6
\&{PATITEM} ${}{*}\\{pi};{}$\7
\X27:Inicializace promìnných pøi startu funkce \PB{\\{tie}}\X;\6
\&{while} ${}(\R\\{feof}(\\{input})){}$\5
${}\{{}$\1\6
\X30:Otevøi nové patterny\X;\6
\&{if} ${}(\\{ap}\E\T{0}\W\\{ind}>\.{BUFI}\W\|c\I\.{'\\\\'}){}$\1\5
\X28:Vyprázdni buffer\X;\2\6
\&{if} ${}(\\{ind}\G\.{MAXBUFF}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"Operating\ buffer\ ov}\)\.{erflow,\ is\
anything\ }\)\.{wrong?\\n"});{}$\6
\\{exit}(\.{BAD\_PROGRAM});\6
\4${}\}{}$\2\6
\&{if} ${}((\\{ic}\K\\{getc}(\\{input}))\E\.{EOF}{}$)\C{ opravil Cejka Rudolf }%
\1\6
\&{break};\2\6
${}\\{buff}[\\{ind}\PP]\K\|c\K\\{ic};{}$\6
\&{if} ${}(\|c\E\.{'\\n'}){}$\1\5
${}\\{numline}\PP,\39\\{listpatt}\K\\{normallist};{}$\2\6
\&{if} ${}(\|c\E\.{'\%'}\W\\{mode}\I\.{VERBMODE}\W\\{buff}[\\{ind}-\T{2}]\I\.{'%
\\\\'}){}$\1\5
${}\\{listpatt}\K\\{commentlist};{}$\2\6
\X29:Projdi otevøené patterny\X;\6
\4${}\}{}$\2\6
\X28:Vyprázdni buffer\X;\6
\&{if} ${}(\R\\{web}){}$\1\5
\\{checkmode}(\,);\C{ zaverecna kontrola modu }\2\6
\&{if} ${}(\R\\{silent}){}$\1\5
\X32:Tiskni závìreènou zprávu\X;\2\6
\4${}\}{}$\2\par
\U1.\fi

\M{27}\B\X27:Inicializace promìnných pøi startu funkce \PB{\\{tie}}\X${}\E{}$\6
\&{for} ${}(\|k\K\T{0};{}$ ${}\|k<\.{MAXPATT};{}$ ${}\|k\PP){}$\1\5
${}\\{lapi}[\|k]\K\NULL;{}$\2\6
${}\|c\K\.{'\\n'};{}$\6
${}\\{buff}[\T{0}]\K\\{mode}\K\\{ap}\K\T{0};{}$\6
${}\\{ind}\K\T{1};{}$\6
${}\\{numline}\K\T{1};{}$\6
${}\\{numchanges}\K\T{0};{}$\6
${}\\{mode}\K\.{TEXTMODE}{}$;\par
\A35.
\U26.\fi

\M{28}Pøi manipulaci s bufferem byl pou¾it jeden trik. Ve¹keré naètené znaky
zaèínají a¾ od \PB{\\{buff}[\T{1}]}, zatímco \PB{\\{buff}[\T{0}]} je rovno
nule. Je to proto, ¾e
nìkteré algoritmy se vrací o jeden znak zpìt za svùj pattern, aby zjistily,
zda tam není symbol \uv{\.{\char92}} (napøíklad na výskyt sekvence
\.{\char92\char37} je tøeba reagovat jinak, ne¾ na výskyt obyèejného
procenta). Kdybychm zazaèali od \PB{\\{buff}[\T{0}]}, v nìkterých situacích
bychom se ptali, zda \PB{$\\{buff}[{-}\T{1}]\E\.{'\\\\'}$}, tj. sahali bychom
na neo¹etøené
místo v pamìti.
\Y\B\4\X28:Vyprázdni buffer\X${}\E{}$\6
${}\{{}$\1\6
${}\\{buff}[\\{ind}]\K\T{0};{}$\6
${}\\{fputs}({\AND}\\{buff}[\T{1}],\39\\{output});{}$\6
${}\\{ind}\K\T{1};{}$\6
\4${}\}{}$\2\par
\U26.\fi

\M{29}Pøi procházení otevøenými patterny posunujeme v poli \PB{\\{lapi}} pozice
jednotlivých patternù podle pokynù funkce \PB{\\{match}}, pøípadnì pattern
zavøeme
a pøípadnì vyvoláme proceduru patternu.

Nìkteré patterny v poli \PB{\\{lapi}} u¾ mohou být zavøeny, tak¾e je nutno s
tímto
polem pracovat jako s jakýmsi dìravým sýrem.
\Y\B\4\X29:Projdi otevøené patterny\X${}\E{}$\6
$\|n\K\\{ap};{}$\6
${}\|k\K\T{0};{}$\6
\&{while} (\|n)\5
${}\{{}$\1\6
\&{while} ${}(\\{lapi}[\|k]\E\NULL){}$\1\5
${}\|k\PP{}$;\C{ zastav se na prvnim ukazateli na pattern }\2\6
\&{switch} ${}(\|m\K\\{match}(\\{lapi}[\|k])){}$\5
${}\{{}$\1\6
\4\&{case} \.{FOUND}:\5
${}({*}\\{lapt}[\|k]\MG\\{proc})(\,){}$;\C{ Pattern nalezen, spustit proceduru
}\6
\4\&{case} \.{NOFOUND}:\5
${}\\{lapi}[\|k]\K\NULL{}$;\C{ Deaktivace patternu }\6
${}\\{ap}\MM;{}$\6
\&{break};\6
\4\&{default}:\6
\&{while} ${}(\|m\MM){}$\1\5
${}\\{lapi}[\|k]\K\\{lapi}[\|k]\MG\\{next}{}$;\C{ dalsi pozice patternu }\2\6
\4${}\}{}$\2\6
${}\|k\PP;{}$\6
${}\|n\MM;{}$\6
\4${}\}{}$\2\par
\U26.\fi

\M{30}Pøi otevírání nových patternù, které nejsou v tuto chvíli zablokovány,
se hned vypoøádáme s takovými patterny, které nám dávají rovnou odpovìï
typu \PB{\.{FOUND}} nebo \PB{\.{NOFOUND}}. V takových pøípadech ani nezaná¹íme
ukazatel
na pozici do pole \PB{\\{lapi}}.
\Y\B\4\X30:Otevøi nové patterny\X${}\E{}$\6
$\\{pp}\K\\{listpatt};{}$\6
\&{while} ${}(\\{pp}\I\NULL){}$\5
${}\{{}$\1\6
\&{switch} ${}(\|m\K\\{match}(\\{pp}\MG\\{patt})){}$\5
${}\{{}$\1\6
\4\&{case} \.{FOUND}:\5
${}({*}\\{pp}\MG\\{proc})(\,){}$;\C{ spustit proceduru }\6
\4\&{case} \.{NOFOUND}:\5
\&{break};\6
\4\&{default}:\5
\X31:Vytvoø ukazatel na nový pattern a \PB{\&{break}}\X;\6
\4${}\}{}$\2\6
${}\\{pp}\K\\{pp}\MG\\{next};{}$\6
\4${}\}{}$\2\par
\U26.\fi

\M{31}Není-li hned známa odpovìï, zda pattern vyhovuje èi nikoli,
pøekontrolujeme nejdøíve, zda u¾ není pattern ve stejné pozici otevøený.
Pak najdeme první \uv{díru} v tabulce \PB{\\{lapi}} a tam uhnízdíme nový
ukazatel
na pozici v patternu.
\Y\B\4\X31:Vytvoø ukazatel na nový pattern a \PB{\&{break}}\X${}\E{}$\6
$\\{pi}\K\\{pp}\MG\\{patt};{}$\6
\&{while} ${}(\|m\MM){}$\1\5
${}\\{pi}\K\\{pi}\MG\\{next};{}$\2\6
${}\|n\K\\{ap};{}$\6
${}\|k\K\T{0};{}$\6
\&{while} (\|n)\5
${}\{{}$\1\6
\&{if} ${}(\\{lapi}[\|k]\E\\{pi}){}$\1\5
\&{break};\2\6
\&{if} ${}(\\{lapi}[\|k\PP]\I\NULL){}$\1\5
${}\|n\MM;{}$\2\6
\4${}\}{}$\2\6
\&{if} ${}(\R\|n){}$\5
${}\{{}$\1\6
${}\|k\K\T{0};{}$\6
\&{while} ${}(\\{lapi}[\|k]\I\NULL){}$\1\5
${}\|k\PP;{}$\2\6
\&{if} ${}(\|k\G\.{MAXPATT}){}$\5
${}\{{}$\1\6
${}\\{fprintf}(\\{stderr},\39\.{"I\ cannot\ allocate\ p}\)\.{p,\ is\ anything\
wrong}\)\.{?\\n"});{}$\6
\\{exit}(\.{BAD\_PROGRAM});\6
\4${}\}{}$\2\6
${}\\{lapt}[\|k]\K\\{pp};{}$\6
${}\\{lapi}[\|k]\K\\{pi};{}$\6
${}\\{ap}\PP;{}$\6
\4${}\}{}$\2\par
\U30.\fi

\M{32}Poslední vìcí ve funci \PB{\\{tie}} je tisk závìreèné statistiky
zpracování.
\Y\B\4\X32:Tiskni závìreènou zprávu\X${}\E{}$\6
$\\{fprintf}(\\{stderr},\39\.{"\~\~\~\ file:\ \%s\\t\ \ lin}\)\.{es:\ \%ld,\
changes:\ \%l}\)\.{d\\n"},\39\\{filename},\39\\{numline},\39\\{numchanges}){}$;%
\par
\U26.\fi

\N{1}{33}Inicializace patternù.
Po vytvoøení pøedchozího kódu opírajícího se o~patterny máme nyní v~ruce
pomìrnì silný nástroj na definování rùzných èinností programu prostým
vytvoøením patternu a pøíslu¹né jeho procedury. Pokud budeme chtít
v~budoucnu nìjaký rys programu pøidat, pravdìpodobnì to bude snadné.

Nejprve deklarujeme nìkteré èasto pou¾ívané skupiny znakù v~patternech.

\Y\B\4\X4:Globální deklarace\X${}\mathrel+\E{}$\6
\&{char} \\{tblanks}[\,]${}\K\.{"\ \~\\t"};{}$\6
\&{char} \\{blanks}[\,]${}\K\.{"\ \\t"};{}$\6
\&{char} \\{blankscr}[\,]${}\K\.{"\ \\t\\n"};{}$\6
\&{char} \\{tblankscr}[\,]${}\K\.{"\ \~\\t\\n"};{}$\6
\&{char} \\{nochar}[\,]${}\K\.{"\%\~\\n"};{}$\6
\&{char} \\{cr}[\,]${}\K\.{"\\n"};{}$\6
\&{char} \\{prefixes}[\,]${}\K\.{"[(\{\~"};{}$\6
\&{char} \\{dolar}[\,]${}\K\.{"\$"};{}$\6
\&{char} \\{backslash}[\,]${}\K\.{"\\\\"};{}$\6
\&{char} \\{openbrace}[\,]${}\K\.{"\{"};{}$\6
\&{char} \\{letters}[\,]${}\K\.{"abcdefghijklmnopqrs}\)\.{tuvwxyzABCDEFGHIJKLM}%
\)\.{NOPQRSTUVWXYZ"};{}$\6
\&{PATTERN} ${}{*}\\{vlnkalist},{}$ ${}{*}\\{mathlist},{}$ ${}{*}%
\\{parcheck},{}$ ${}{*}\\{verblist}{}$;\par
\fi

\M{34}Zaèneme definicí nejèastìji pou¾ívaného patternu na vlnkování uvnitø
øádku. Pøipomeòme, ¾e opakované volání funkce \PB{\\{setpattern}} vytváøí
internì
seznam patternù, pøièem¾ o~jejich propojení se nemusíme starat. Vyzvedneme
si z~návratového kódu funkce pouze ukazatel na první polo¾ku seznamu
\PB{\\{normallist}}. Stejnì tak opakované volání funkce \PB{\\{setpi}} vytváøí
seznam
pozic pro naposledy deklarovaný pattern.
\Y\B\4\X21:Inicializace datových struktur\X${}\mathrel+\E{}$\6
$\\{vlnkalist}\K\\{setpattern}(\\{vlnkain});{}$\6
${}\\{setpi}(\\{tblankscr},\39\.{ONE});{}$\6
${}\\{setpi}(\\{tblanks},\39\.{ANY});{}$\6
${}\\{setpi}(\\{prefixes},\39\.{ANY});{}$\6
${}\\{setpi}(\\{charset},\39\.{ONE});{}$\6
${}\\{setpi}(\\{blanks},\39\.{ONE});{}$\6
${}\\{setpi}(\\{blanks},\39\.{ANY});{}$\6
${}\\{setpi}(\\{nochar},\39\.{ONE\_NOT}){}$;\par
\fi

\M{35}\B\X27:Inicializace promìnných pøi startu funkce \PB{\\{tie}}\X${}%
\mathrel+\E{}$\6
$\\{listpatt}\K\\{normallist}\K\\{vlnkalist}{}$;\par
\fi

\M{36}\B\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} \\{vlnkain}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{char} \|p;\7
${}\\{ind}\MM;{}$\6
${}\|p\K\\{buff}[\\{ind}\MM];{}$\6
\&{while} ${}(\\{strchr}(\\{blanks},\39\\{buff}[\\{ind}])\I\NULL){}$\1\5
${}\\{ind}\MM;{}$\2\6
${}\\{ind}\PP;{}$\6
${}\\{buff}[\\{ind}\PP]\K\.{'\~'};{}$\6
${}\\{buff}[\\{ind}\PP]\K\|p;{}$\6
${}\\{numchanges}\PP;{}$\6
\4${}\}{}$\2\par
\fi

\M{37}Podobnì pro tvorbu vlnky \uv{pøes øádek} vytvoøíme pattern a kód
procedury.
\Y\B\4\X21:Inicializace datových struktur\X${}\mathrel+\E{}$\6
\\{setpattern}(\\{vlnkacr});\6
${}\\{setpi}(\\{tblankscr},\39\.{ONE});{}$\6
${}\\{setpi}(\\{tblanks},\39\.{ANY});{}$\6
${}\\{setpi}(\\{prefixes},\39\.{ANY});{}$\6
${}\\{setpi}(\\{charset},\39\.{ONE});{}$\6
${}\\{setpi}(\\{blanks},\39\.{ANY});{}$\6
${}\\{setpi}(\\{cr},\39\.{ONE});{}$\6
${}\\{setpi}(\\{blanks},\39\.{ANY});{}$\6
${}\\{setpi}(\\{nochar},\39\.{ONE\_NOT}){}$;\par
\fi

\M{38}V proceduøe k tomuto patternu musíme o¹etøit pøípad typu
\uv{\.{a\char126v\char92np}},
kdy nelze prostì pøehodit \uv{\.{\char92n}} za \uv{\.{v}}, proto¾e
bychom roztrhli
mezeru svázanou vlnkou u¾ døíve. Proto musíme vyhledat vhodné místo pro
roztr¾ení øádku, které bude a¾ {\it pøed\/} znakem \uv{\.{a}}. Pøi dùsledném
o¹etøení tohoto fenoménu mù¾eme dokonce narazit na situaci
\uv{\.{\char92n\ v\char126v\char126v\char92np}},  kde nemù¾eme vlo¾it
\uv{\.{\char92n}} pøed první výskyt \uv{\.{v}}, proto¾e bychom dostali
\uv{\.{\char92n\char92n}}, tedy prázdný
øádek. Ten je v \TeX{}u interperetován odli¹nì. V této výjimeèné
situaci pouze zru¹íme stávající (v poøadí druhé) \uv{\.{\char92n}} a
nebudeme vytváøet nové. Na výstupu bude soubor o jeden øádek krat¹í.
\Y\B\4\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} \\{vlnkacr}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{char} \|p;\6
\&{int} \|i${},{}$ \|j;\7
${}\\{ind}\MM;{}$\6
${}\|p\K\\{buff}[\\{ind}\MM];{}$\6
\&{while} ${}(\\{strchr}(\\{blankscr},\39\\{buff}[\\{ind}])\I\NULL){}$\1\5
${}\\{ind}\MM;{}$\2\6
${}\|i\K\\{ind}{}$;\C{ misto predlozky, kterou chceme vazat }\6
\&{while} ${}(\|i\G\T{0}\W(\\{strchr}(\\{blankscr},\39\\{buff}[\|i])\E%
\NULL)){}$\1\5
${}\|i\MM;{}$\2\6
${}\|j\K\|i;{}$\6
\&{while} ${}(\|i\G\T{0}\W(\\{strchr}(\\{blanks},\39\\{buff}[\|i])\I\NULL)){}$%
\1\5
${}\|i\MM;{}$\2\6
\&{if} ${}(\|i\G\T{0}\W\\{buff}[\|i]\E\.{'\\n'}){}$\1\5
${}\|j\K{-}\T{1};{}$\2\6
\&{if} ${}(\|j\G\T{0}){}$\1\5
${}\\{buff}[\|j]\K\.{'\\n'};{}$\2\6
\&{else}\1\5
${}\\{numline}\MM;{}$\2\6
${}\\{ind}\PP;{}$\6
${}\\{buff}[\\{ind}\PP]\K\.{'\~'};{}$\6
${}\\{buff}[\\{ind}\PP]\K\|p;{}$\6
${}\\{numchanges}\PP;{}$\6
\4${}\}{}$\2\par
\fi

\M{39}Nyní vytvoøíme patterny pro pøípady typu \.{\char92uv\char`\{v lese\char`%
\}}.
\Y\B\4\X21:Inicializace datových struktur\X${}\mathrel+\E{}$\6
\\{setpattern}(\\{vlnkain});\C{ na radku }\6
${}\\{setpi}(\\{tblankscr},\39\.{ONE});{}$\6
${}\\{setpi}(\\{backslash},\39\.{ONE});{}$\6
${}\\{setpi}(\\{letters},\39\.{ONE});{}$\6
${}\\{setpi}(\\{letters},\39\.{ANY});{}$\6
${}\\{setpi}(\\{openbrace},\39\.{ONE});{}$\6
${}\\{setpi}(\\{prefixes},\39\.{ANY});{}$\6
${}\\{setpi}(\\{charset},\39\.{ONE});{}$\6
${}\\{setpi}(\\{blanks},\39\.{ONE});{}$\6
${}\\{setpi}(\\{blanks},\39\.{ANY});{}$\6
${}\\{setpi}(\\{nochar},\39\.{ONE\_NOT});{}$\6
\\{setpattern}(\\{vlnkacr});\C{ pres radek }\6
${}\\{setpi}(\\{tblankscr},\39\.{ONE});{}$\6
${}\\{setpi}(\\{backslash},\39\.{ONE});{}$\6
${}\\{setpi}(\\{letters},\39\.{ONE});{}$\6
${}\\{setpi}(\\{letters},\39\.{ANY});{}$\6
${}\\{setpi}(\\{openbrace},\39\.{ONE});{}$\6
${}\\{setpi}(\\{prefixes},\39\.{ANY});{}$\6
${}\\{setpi}(\\{charset},\39\.{ONE});{}$\6
${}\\{setpi}(\\{blanks},\39\.{ANY});{}$\6
${}\\{setpi}(\\{cr},\39\.{ONE});{}$\6
${}\\{setpi}(\\{blanks},\39\.{ANY});{}$\6
${}\\{setpi}(\\{nochar},\39\.{ONE\_NOT}){}$;\par
\fi

\M{40}Vytvoøíme patterny a proceduru pro potlatèení tvorby vlnky u písmen tìsnì
následujících sekvence \.{\char92TeX} a \.{\char92LaTeX}. Tj. nechceme, aby
napø z textu \uv{\.{Vlastnosti~\char92TeX~u~jsou...}} jsme dostali text
s nesprávnì vázaným písmenem
\uv{\.{Vlastnosti~\char92TeX~u\char126jsou...}}.
\Y\B\4\X21:Inicializace datových struktur\X${}\mathrel+\E{}$\6
$\\{normalpattern}(\\{tielock},\39\.{"\\\\TeX"});{}$\6
${}\\{setpi}(\\{blankscr},\39\.{ONE});{}$\6
${}\\{normalpattern}(\\{tielock},\39\.{"\\\\LaTeX"});{}$\6
${}\\{setpi}(\\{blankscr},\39\.{ONE}){}$;\par
\fi

\M{41}Procedura \PB{\\{tielock}} obsahuje neèistý trik. Pøi provádìní procedury
je
právì naèten znak z \PB{\\{blankscr}} a je ulo¾en do buff. Testy na otevírání
nových patternù pro tento znak teprve budou následovat a testují se na
hodnotu promìnné \PB{\|c}. Staèí tedy zmìnit hodnotu \PB{\|c} a vlnkovací
patterny se
neotevøou.
\Y\B\4\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} \\{tielock}(\,)\1\1\2\2\6
${}\{{}$\1\6
${}\|c\K\T{1};{}$\6
\4${}\}{}$\2\par
\fi

\M{42}O¹etøíme nyní pøechod do/z matematického re¾imu \TeX{}u. Uvnitø math
módu vlnky nedìláme. Pøi zji¹tìném nesouladu v pøechodech mezi
math-módy spustíme následující proceduru.
\Y\B\4\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} \\{printwarning}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\R\\{silent}){}$\1\5
${}\\{fprintf}(\\{stderr},\39\.{"\~!\~\ warning:\ text/m}\)\.{ath/verb\ mode\
mismat}\)\.{ch,\ \ file:\ \%s,\ \ line}\)\.{:\ \%ld\\n"},\39\\{filename},\39%
\\{numline}-(\|c\E\.{'\\n'}\?\T{1}:\T{0}));{}$\2\6
${}\\{status}\K\.{WARNING};{}$\6
\4${}\}{}$\2\par
\fi

\M{43}Zaèneme patterny pro pøechod do/z matematického re¾imu, ohranièeného
jedním dolarem, nebo v La\TeX{}u pøíslu¹nými sekvencemi.  Sekvence
La\TeX{}u \.{\char92(} a \.{\char92)} nejsou zahrnuty, proto¾e bývají
èasto pøedefinovány k jiným u¾iteènìj¹ím vìcem.
\Y\B\4\X21:Inicializace datových struktur\X${}\mathrel+\E{}$\6
\&{if} ${}(\R\\{nomath}){}$\5
${}\{{}$\1\6
${}\\{mathlist}\K\\{setpattern}(\\{onedollar});{}$\6
${}\\{setpi}(\\{dolar},\39\.{ONE});{}$\6
${}\\{setpi}(\\{dolar},\39\.{ONE\_NOT});{}$\6
\&{if} (\\{latex})\5
${}\{{}$\1\6
${}\\{normalpattern}(\\{mathin},\39\.{"\\\\begin.\{math\}"});{}$\6
${}\\{normalpattern}(\\{mathout},\39\.{"\\\\end.\{math\}"});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{44}\B\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} \\{mathin}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mode}\I\.{TEXTMODE}){}$\1\5
\\{printwarning}(\,);\2\6
${}\\{mode}\K\.{MATHMODE};{}$\6
${}\\{normallist}\K\\{listpatt}\K\\{mathlist};{}$\6
\4${}\}{}$\2\7
\&{void} \\{mathout}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mode}\I\.{MATHMODE}){}$\1\5
\\{printwarning}(\,);\2\6
${}\\{mode}\K\.{TEXTMODE};{}$\6
${}\\{normallist}\K\\{listpatt}\K\\{vlnkalist};{}$\6
\4${}\}{}$\2\par
\fi

\M{45}Pøi programování procedury \PB{\\{onedollar}} nesmíme zapomenout na
výskyt
sekvence \.{\char92\$}. V tom pøípadì akci ignorujeme. Podobnì u sekvence
\.{\$\$} souhlasí ten druhý dolar s na¹ím patternem, ale to u¾ jsme uvnitø
display módu. V takovém pøípadì také nic nedìláme.
\Y\B\4\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} \\{onedollar}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{buff}[\\{ind}-\T{3}]\E\.{'\\\\'}\V(\\{buff}[\\{ind}-\T{3}]\E\.{'%
\$'}\W\\{buff}[\\{ind}-\T{4}]\I\.{'\\\\'})){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{mode}\E\.{DISPLAYMODE}){}$\1\5
\\{printwarning}(\,);\2\6
\&{else}\5
${}\{{}$\1\6
\&{if} ${}(\\{mode}\E\.{TEXTMODE}){}$\1\5
\\{mathin}(\,);\2\6
\&{else}\1\5
\\{mathout}(\,);\2\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{46}Pokud najdeme prázdný øádek, pøekontrolujeme, zda náhodou nejsme v
math-módu. Pokud ano, vypí¹eme varování a pøejdeme do textového módu.
\Y\B\4\X21:Inicializace datových struktur\X${}\mathrel+\E{}$\6
$\\{parcheck}\K\\{setpattern}(\\{checkmode});{}$\6
${}\\{setpi}(\\{cr},\39\.{ONE});{}$\6
${}\\{setpi}(\\{blanks},\39\.{ANY});{}$\6
${}\\{setpi}(\\{cr},\39\.{ONE}){}$;\par
\fi

\M{47}\B\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} \\{checkmode}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mode}\I\.{TEXTMODE}){}$\5
${}\{{}$\1\6
\\{printwarning}(\,);\6
${}\\{mode}\K\.{TEXTMODE};{}$\6
${}\\{normallist}\K\\{listpatt}\K\\{vlnkalist};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{48}Nyní o¹etøíme výskyt dvou dolarù, tj. vstup do/z display módu.
Rovnì¾ mysleme na La\TeX{}isty a jejich prostøedí pro display-mód. Proto¾e
je mo¾ná alternativa s hvìzdièkou na konci názvu prostøedí, radìji u¾
uzavírací závorku do patternu nezahrnujeme.

\Y\B\4\X21:Inicializace datových struktur\X${}\mathrel+\E{}$\6
\&{if} ${}(\R\\{nomath}){}$\5
${}\{{}$\1\6
${}\\{normalpattern}(\\{twodollars},\39\.{"\$\$"});{}$\6
\&{if} (\\{latex})\5
${}\{{}$\1\6
${}\\{normalpattern}(\\{displayin},\39\.{"\\\\begin.\{displaymat}\)\.{h"});{}$\6
${}\\{normalpattern}(\\{displayin},\39\.{"\\\\begin.\{equation"});{}$\6
${}\\{normalpattern}(\\{displayout},\39\.{"\\\\end.\{displaymath"});{}$\6
${}\\{normalpattern}(\\{displayout},\39\.{"\\\\end.\{equation"});{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{49}\B\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} \\{displayin}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mode}\I\.{TEXTMODE}){}$\1\5
\\{printwarning}(\,);\2\6
${}\\{mode}\K\.{DISPLAYMODE};{}$\6
${}\\{normallist}\K\\{listpatt}\K\\{parcheck};{}$\6
\4${}\}{}$\2\7
\&{void} \\{displayout}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mode}\I\.{DISPLAYMODE}){}$\1\5
\\{printwarning}(\,);\2\6
${}\\{mode}\K\.{TEXTMODE};{}$\6
${}\\{normallist}\K\\{listpatt}\K\\{vlnkalist};{}$\6
\4${}\}{}$\2\7
\&{void} \\{twodollars}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{buff}[\\{ind}-\T{3}]\E\.{'\\\\'}){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{mode}\E\.{DISPLAYMODE}){}$\1\5
\\{displayout}(\,);\2\6
\&{else}\1\5
\\{displayin}(\,);\2\6
\4${}\}{}$\2\par
\fi

\M{50}Následuje o¹etøení tzv. verbatim módu. Pro plain i La\TeX{} jsou
nejèastìj¹í
závorky pro verbatim mod tyto (variantu s \.{\char92begtt} pou¾ívám
s oblibou já).
\Y\B\4\X21:Inicializace datových struktur\X${}\mathrel+\E{}$\6
\&{if} ${}(\R\\{noverb}){}$\5
${}\{{}$\1\6
${}\\{verblist}\K\\{normalpattern}(\\{verbinchar},\39\.{"\\\\verb"});{}$\6
${}\\{setpi}(\\{blankscr},\39\.{ANY});{}$\6
${}\\{setpi}(\\{blankscr},\39\.{ONE\_NOT});{}$\6
${}\\{normalpattern}(\\{verbin},\39\.{"\\\\begtt"});{}$\6
\&{if} (\\{latex})\1\5
${}\\{normalpattern}(\\{verbin},\39\.{"\\\\begin.\{verbatim"});{}$\2\6
\4${}\}{}$\2\6
\&{if} (\\{web})\5
${}\{{}$\1\6
${}\\{normalpattern}(\\{verbin},\39\.{"@<"});{}$\6
${}\\{normalpattern}(\\{verbin},\39\.{"@d"});{}$\6
\4${}\}{}$\2\6
\&{if} ${}(\R\\{noverb}){}$\5
${}\{{}$\1\6
${}\\{verboutlist}[\T{0}]\K\\{setpattern}(\\{verbout});{}$\6
${}\\{setpi}(\\{verbchar},\39\.{ONE});{}$\6
${}\\{verboutlist}[\T{1}]\K\\{normalpattern}(\\{verbout},\39\.{"%
\\\\endtt"});{}$\6
\&{if} (\\{latex})\1\5
${}\\{verboutlist}[\T{2}]\K\\{normalpattern}(\\{verbout},\39\.{"\\\\end%
\{verbatim"});{}$\2\6
\4${}\}{}$\2\6
\&{if} (\\{web})\5
${}\{{}$\1\6
${}\\{verboutlist}[\T{3}]\K\\{normalpattern}(\\{verbout},\39\.{"@\ "});{}$\6
${}\\{normalpattern}(\\{verbout},\39\.{"@*"});{}$\6
${}\\{normalpattern}(\\{verbout},\39\.{"@>|"});{}$\6
\4${}\}{}$\2\par
\fi

\M{51}Procedura \PB{\\{verbinchar}} se od \uv{spoleèné} procedury \PB{%
\\{verbin}} li¹í v
tom, ¾e zavede do stringu \PB{\\{verbchar}} momentální hodnotu promìnné \PB{%
\|c}.
Proto druhý výskyt této hodnoty verbatim re¾im ukonèí.
\Y\B\4\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{int} \\{prevmode};\6
\&{PATTERN} ${}{*}\\{prevlist},{}$ ${}{*}\\{verboutlist}[\T{4}];{}$\6
\&{char} \\{verbchar}[\T{2}];\7
\&{void} \\{verbinchar}(\,)\1\1\2\2\6
${}\{{}$\1\6
${}\\{prevmode}\K\\{mode};{}$\6
${}\\{verbchar}[\T{0}]\K\|c;{}$\6
${}\|c\K\T{1};{}$\6
${}\\{listpatt}\K\\{normallist}\K\\{verboutlist}[\T{0}];{}$\6
${}\\{prevlist}\K\\{listpatt}\MG\\{next};{}$\6
${}\\{listpatt}\MG\\{next}\K\NULL;{}$\6
${}\\{mode}\K\.{VERBMODE};{}$\6
\4${}\}{}$\2\par
\fi

\M{52}Pøi programování \uv{obecné} funkce \PB{\\{verbin}} musíme dbát na to,
aby
zùstal aktivní pouze odpovídající \uv{výstupní} pattern k danému
vstupnímu. Také si zapamatujeme mód, ze kterého jsme do verbatim
oblasti vstoupili, abychom se k nìmu mohli vrátit (napø. uvnitø
math. módu mù¾e být
\.{\char92hbox} a v nìm lokálnì verbatim konstrukce).
\Y\B\4\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} \\{verbin}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{int} \|i;\7
${}\|i\K\T{0};{}$\6
${}\\{prevmode}\K\\{mode};{}$\6
\&{switch} (\|c)\5
${}\{{}$\1\6
\4\&{case} \.{'t'}:\5
${}\|i\K\T{1};{}$\6
\&{break};\6
\4\&{case} \.{'m'}:\5
${}\|i\K\T{2};{}$\6
\&{break};\6
\4\&{case} \.{'<'}:\5
;\6
\4\&{case} \.{'d'}:\5
${}\|i\K\T{3};{}$\6
\&{if} ${}(\\{buff}[\\{ind}-\T{3}]\E\.{'@'}){}$\1\5
\&{return};\C{ dvojity @ ignorovat }\2\6
\&{break};\6
\4${}\}{}$\2\6
${}\\{listpatt}\K\\{normallist}\K\\{verboutlist}[\|i];{}$\6
${}\\{prevlist}\K\\{listpatt}\MG\\{next};{}$\6
\&{if} ${}(\|c\I\.{'<'}\W\|c\I\.{'d'}){}$\1\5
${}\\{listpatt}\MG\\{next}\K\NULL;{}$\2\6
${}\\{mode}\K\.{VERBMODE};{}$\6
\4${}\}{}$\2\par
\fi

\M{53}\B\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} \\{verbout}(\,)\1\1\2\2\6
${}\{{}$\1\6
\&{if} ${}(\\{mode}\I\.{VERBMODE}){}$\1\5
\&{return};\2\6
\&{if} ${}(\\{web}\W\\{buff}[\\{ind}-\T{2}]\E\.{'@'}\W\\{buff}[\\{ind}-\T{3}]\E%
\.{'@'}){}$\1\5
\&{return};\2\6
${}\\{mode}\K\\{prevmode};{}$\6
${}\\{normallist}\MG\\{next}\K\\{prevlist};{}$\6
\&{switch} (\\{mode})\5
${}\{{}$\1\6
\4\&{case} \.{DISPLAYMODE}:\5
${}\\{normallist}\K\\{listpatt}\K\\{parcheck};{}$\6
\&{break};\6
\4\&{case} \.{MATHMODE}:\5
${}\\{normallist}\K\\{listpatt}\K\\{mathlist};{}$\6
\&{break};\6
\4\&{case} \.{TEXTMODE}:\5
${}\\{normallist}\K\\{listpatt}\K\\{vlnkalist};{}$\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\fi

\M{54}Nyní implementujeme vlastnost døíve pou¾ívaného programu vlnka, tj. ¾e
lze jeho èinnost vypnout a opìt zapnout v komentáøích. Vytváøíme druhý
nezávislý seznam patternù a proto nejprve pronulujeme \PB{\\{lastpt}}.
\Y\B\4\X21:Inicializace datových struktur\X${}\mathrel+\E{}$\6
$\\{lastpt}\K\T{0};{}$\6
${}\\{commentlist}\K\\{normalpattern}(\\{tieoff},\39\.{"\%.\~.-"});{}$\6
${}\\{normalpattern}(\\{tieon},\39\.{"\%.\~.+"}){}$;\par
\fi

\M{55}\B\X6:Pomocné funkce\X${}\mathrel+\E{}$\6
\&{void} \\{tieoff}(\,)\1\1\2\2\6
${}\{{}$\1\6
${}\\{normallist}\K\NULL;{}$\6
\4${}\}{}$\2\7
\&{void} \\{tieon}(\,)\1\1\2\2\6
${}\{{}$\1\6
${}\\{normallist}\K\\{vlnkalist};{}$\6
\4${}\}{}$\2\par
\fi

\M{56}Dal¹í plánovaná vylep¹ení. Program by mohl èíst definici svého chování
nejen z~pøíkazové øádky, ale v~mnohem kompletnìj¹í podobì, vèetnì
u¾ivatelsky definovaných patternù, z komentáøové oblasti ve èteném souboru.
Parametry zde uvedené by mohly mít vy¹¹í prioritu, ne¾ parametry
z~pøíkazové øádky a mohl by se tøeba roz¹iøovat seznam sekvencí, za nimi¾
písmena nemají být vázana vlnkou (zatím je implemenováno na pevno jen
\.{\char92TeX} a \.{\char92LaTeX}).

\fi

\N{1}{57}Rejstøík.


\fi


\inx
\fin
\con
